<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Weighers.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">instrumentation-api</a> &gt; <a href="index.source.html" class="el_package">io.opentelemetry.instrumentation.api.internal.cache.concurrentlinkedhashmap</a> &gt; <span class="el_source">Weighers.java</span></div><h1>Weighers.java</h1><pre class="source lang-java linenums">/*
 * Copyright The OpenTelemetry Authors
 * SPDX-License-Identifier: Apache-2.0
 */

// Includes work from:
/*
 * Copyright 2010 Google Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package io.opentelemetry.instrumentation.api.internal.cache.concurrentlinkedhashmap;

import java.io.Serializable;
import java.util.Collection;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

/**
 * A common set of {@link Weigher} and {@link EntryWeigher} implementations.
 *
 * @author ben.manes@gmail.com (Ben Manes)
 * @see &lt;a href=&quot;http://code.google.com/p/concurrentlinkedhashmap/&quot;&gt;
 *     http://code.google.com/p/concurrentlinkedhashmap/&lt;/a&gt;
 */
public final class Weighers {

<span class="nc" id="L41">  private Weighers() {</span>
<span class="nc" id="L42">    throw new AssertionError();</span>
  }

  /**
   * A entry weigher backed by the specified weigher. The weight of the value determines the weight
   * of the entry.
   *
   * @param weigher the weigher to be &quot;wrapped&quot; in a entry weigher.
   * @return A entry weigher view of the specified weigher.
   */
  public static &lt;K, V&gt; EntryWeigher&lt;K, V&gt; asEntryWeigher(final Weigher&lt;? super V&gt; weigher) {
<span class="nc bnc" id="L53" title="All 2 branches missed.">    return (weigher == singleton())</span>
<span class="nc" id="L54">        ? Weighers.&lt;K, V&gt;entrySingleton()</span>
<span class="nc" id="L55">        : new EntryWeigherView&lt;&gt;(weigher);</span>
  }

  /**
   * A weigher where an entry has a weight of &lt;tt&gt;1&lt;/tt&gt;. A map bounded with this weigher will evict
   * when the number of key-value pairs exceeds the capacity.
   *
   * @return A weigher where a value takes one unit of capacity.
   */
  @SuppressWarnings({&quot;cast&quot;, &quot;unchecked&quot;})
  public static &lt;K, V&gt; EntryWeigher&lt;K, V&gt; entrySingleton() {
<span class="fc" id="L66">    return (EntryWeigher&lt;K, V&gt;) SingletonEntryWeigher.INSTANCE;</span>
  }

  /**
   * A weigher where a value has a weight of &lt;tt&gt;1&lt;/tt&gt;. A map bounded with this weigher will evict
   * when the number of key-value pairs exceeds the capacity.
   *
   * @return A weigher where a value takes one unit of capacity.
   */
  @SuppressWarnings({&quot;cast&quot;, &quot;unchecked&quot;})
  public static &lt;V&gt; Weigher&lt;V&gt; singleton() {
<span class="nc" id="L77">    return (Weigher&lt;V&gt;) SingletonWeigher.INSTANCE;</span>
  }

  /**
   * A weigher where the value is a byte array and its weight is the number of bytes. A map bounded
   * with this weigher will evict when the number of bytes exceeds the capacity rather than the
   * number of key-value pairs in the map. This allows for restricting the capacity based on the
   * memory-consumption and is primarily for usage by dedicated caching servers that hold the
   * serialized data.
   *
   * &lt;p&gt;A value with a weight of &lt;tt&gt;0&lt;/tt&gt; will be rejected by the map. If a value with this weight
   * can occur then the caller should eagerly evaluate the value and treat it as a removal
   * operation. Alternatively, a custom weigher may be specified on the map to assign an empty value
   * a positive weight.
   *
   * @return A weigher where each byte takes one unit of capacity.
   */
  public static Weigher&lt;byte[]&gt; byteArray() {
<span class="nc" id="L95">    return ByteArrayWeigher.INSTANCE;</span>
  }

  /**
   * A weigher where the value is a {@link Iterable} and its weight is the number of elements. This
   * weigher only should be used when the alternative {@link #collection()} weigher cannot be, as
   * evaluation takes O(n) time. A map bounded with this weigher will evict when the total number of
   * elements exceeds the capacity rather than the number of key-value pairs in the map.
   *
   * &lt;p&gt;A value with a weight of &lt;tt&gt;0&lt;/tt&gt; will be rejected by the map. If a value with this weight
   * can occur then the caller should eagerly evaluate the value and treat it as a removal
   * operation. Alternatively, a custom weigher may be specified on the map to assign an empty value
   * a positive weight.
   *
   * @return A weigher where each element takes one unit of capacity.
   */
  @SuppressWarnings({&quot;cast&quot;, &quot;unchecked&quot;})
  public static &lt;E&gt; Weigher&lt;? super Iterable&lt;E&gt;&gt; iterable() {
<span class="nc" id="L113">    return (Weigher&lt;Iterable&lt;E&gt;&gt;) (Weigher&lt;?&gt;) IterableWeigher.INSTANCE;</span>
  }

  /**
   * A weigher where the value is a {@link Collection} and its weight is the number of elements. A
   * map bounded with this weigher will evict when the total number of elements exceeds the capacity
   * rather than the number of key-value pairs in the map.
   *
   * &lt;p&gt;A value with a weight of &lt;tt&gt;0&lt;/tt&gt; will be rejected by the map. If a value with this weight
   * can occur then the caller should eagerly evaluate the value and treat it as a removal
   * operation. Alternatively, a custom weigher may be specified on the map to assign an empty value
   * a positive weight.
   *
   * @return A weigher where each element takes one unit of capacity.
   */
  @SuppressWarnings({&quot;cast&quot;, &quot;unchecked&quot;})
  public static &lt;E&gt; Weigher&lt;? super Collection&lt;E&gt;&gt; collection() {
<span class="nc" id="L130">    return (Weigher&lt;Collection&lt;E&gt;&gt;) (Weigher&lt;?&gt;) CollectionWeigher.INSTANCE;</span>
  }

  /**
   * A weigher where the value is a {@link List} and its weight is the number of elements. A map
   * bounded with this weigher will evict when the total number of elements exceeds the capacity
   * rather than the number of key-value pairs in the map.
   *
   * &lt;p&gt;A value with a weight of &lt;tt&gt;0&lt;/tt&gt; will be rejected by the map. If a value with this weight
   * can occur then the caller should eagerly evaluate the value and treat it as a removal
   * operation. Alternatively, a custom weigher may be specified on the map to assign an empty value
   * a positive weight.
   *
   * @return A weigher where each element takes one unit of capacity.
   */
  @SuppressWarnings({&quot;cast&quot;, &quot;unchecked&quot;})
  public static &lt;E&gt; Weigher&lt;? super List&lt;E&gt;&gt; list() {
<span class="nc" id="L147">    return (Weigher&lt;List&lt;E&gt;&gt;) (Weigher&lt;?&gt;) ListWeigher.INSTANCE;</span>
  }

  /**
   * A weigher where the value is a {@link Set} and its weight is the number of elements. A map
   * bounded with this weigher will evict when the total number of elements exceeds the capacity
   * rather than the number of key-value pairs in the map.
   *
   * &lt;p&gt;A value with a weight of &lt;tt&gt;0&lt;/tt&gt; will be rejected by the map. If a value with this weight
   * can occur then the caller should eagerly evaluate the value and treat it as a removal
   * operation. Alternatively, a custom weigher may be specified on the map to assign an empty value
   * a positive weight.
   *
   * @return A weigher where each element takes one unit of capacity.
   */
  @SuppressWarnings({&quot;cast&quot;, &quot;unchecked&quot;})
  public static &lt;E&gt; Weigher&lt;? super Set&lt;E&gt;&gt; set() {
<span class="nc" id="L164">    return (Weigher&lt;Set&lt;E&gt;&gt;) (Weigher&lt;?&gt;) SetWeigher.INSTANCE;</span>
  }

  /**
   * A weigher where the value is a {@link Map} and its weight is the number of entries. A map
   * bounded with this weigher will evict when the total number of entries across all values exceeds
   * the capacity rather than the number of key-value pairs in the map.
   *
   * &lt;p&gt;A value with a weight of &lt;tt&gt;0&lt;/tt&gt; will be rejected by the map. If a value with this weight
   * can occur then the caller should eagerly evaluate the value and treat it as a removal
   * operation. Alternatively, a custom weigher may be specified on the map to assign an empty value
   * a positive weight.
   *
   * @return A weigher where each entry takes one unit of capacity.
   */
  @SuppressWarnings({&quot;cast&quot;, &quot;unchecked&quot;})
  public static &lt;A, B&gt; Weigher&lt;? super Map&lt;A, B&gt;&gt; map() {
<span class="nc" id="L181">    return (Weigher&lt;Map&lt;A, B&gt;&gt;) (Weigher&lt;?&gt;) MapWeigher.INSTANCE;</span>
  }

  static final class EntryWeigherView&lt;K, V&gt; implements EntryWeigher&lt;K, V&gt;, Serializable {
    static final long serialVersionUID = 1;
    final Weigher&lt;? super V&gt; weigher;

<span class="nc" id="L188">    EntryWeigherView(Weigher&lt;? super V&gt; weigher) {</span>
<span class="nc" id="L189">      ConcurrentLinkedHashMap.checkNotNull(weigher);</span>
<span class="nc" id="L190">      this.weigher = weigher;</span>
<span class="nc" id="L191">    }</span>

    @Override
    public int weightOf(K key, V value) {
<span class="nc" id="L195">      return weigher.weightOf(value);</span>
    }
  }

<span class="fc" id="L199">  enum SingletonEntryWeigher implements EntryWeigher&lt;Object, Object&gt; {</span>
<span class="fc" id="L200">    INSTANCE;</span>

    @Override
    public int weightOf(Object key, Object value) {
<span class="fc" id="L204">      return 1;</span>
    }
  }

<span class="nc" id="L208">  enum SingletonWeigher implements Weigher&lt;Object&gt; {</span>
<span class="nc" id="L209">    INSTANCE;</span>

    @Override
    public int weightOf(Object value) {
<span class="nc" id="L213">      return 1;</span>
    }
  }

<span class="nc" id="L217">  enum ByteArrayWeigher implements Weigher&lt;byte[]&gt; {</span>
<span class="nc" id="L218">    INSTANCE;</span>

    @Override
    public int weightOf(byte[] value) {
<span class="nc" id="L222">      return value.length;</span>
    }
  }

<span class="nc" id="L226">  enum IterableWeigher implements Weigher&lt;Iterable&lt;?&gt;&gt; {</span>
<span class="nc" id="L227">    INSTANCE;</span>

    @Override
    public int weightOf(Iterable&lt;?&gt; values) {
<span class="nc bnc" id="L231" title="All 2 branches missed.">      if (values instanceof Collection&lt;?&gt;) {</span>
<span class="nc" id="L232">        return ((Collection&lt;?&gt;) values).size();</span>
      }
<span class="nc" id="L234">      int size = 0;</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">      for (Iterator&lt;?&gt; i = values.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L236">        i.next();</span>
<span class="nc" id="L237">        size++;</span>
      }
<span class="nc" id="L239">      return size;</span>
    }
  }

<span class="nc" id="L243">  enum CollectionWeigher implements Weigher&lt;Collection&lt;?&gt;&gt; {</span>
<span class="nc" id="L244">    INSTANCE;</span>

    @Override
    public int weightOf(Collection&lt;?&gt; values) {
<span class="nc" id="L248">      return values.size();</span>
    }
  }

<span class="nc" id="L252">  enum ListWeigher implements Weigher&lt;List&lt;?&gt;&gt; {</span>
<span class="nc" id="L253">    INSTANCE;</span>

    @Override
    public int weightOf(List&lt;?&gt; values) {
<span class="nc" id="L257">      return values.size();</span>
    }
  }

<span class="nc" id="L261">  enum SetWeigher implements Weigher&lt;Set&lt;?&gt;&gt; {</span>
<span class="nc" id="L262">    INSTANCE;</span>

    @Override
    public int weightOf(Set&lt;?&gt; values) {
<span class="nc" id="L266">      return values.size();</span>
    }
  }

<span class="nc" id="L270">  enum MapWeigher implements Weigher&lt;Map&lt;?, ?&gt;&gt; {</span>
<span class="nc" id="L271">    INSTANCE;</span>

    @Override
    public int weightOf(Map&lt;?, ?&gt; values) {
<span class="nc" id="L275">      return values.size();</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>